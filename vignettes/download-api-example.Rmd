---
title: "Insight API download from SciDB"
author: "Paradigm4 Customer Solutions"
output:
  html_document: default
  pdf_document:
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(scidb4gh)
```

## Connect to the database

```{r connect}
library(scidb4gh)
gh_connect()
```

## Dataset

Everything is linked at the level of the dataset

```{r dataset}
dataset_id = 1
d = get_datasets(dataset_id = dataset_id)
print(d)
```

## Individuals

Patients and samples in a dataset

```{r echo = FALSE}
merge_individual_sample = function(dfi, dfb) {
  dfi = plyr::rename(dfi, c('name' = 'individual_name'))
  merge(dfi[, c('individual_id', 'individual_name', 'sex_', 'race', 'species_')], dfb,
        by = 'individual_id')
}
```

```{r sample}
i = search_individuals(dataset_id = dataset_id)

b = search_biosamples(dataset_id = dataset_id)

b2 = merge_individual_sample(dfi = i, dfb = b)
print(b2)
```

## Pipelines

Processing pipelines

```{r pipelines}
m = search_measurementsets(dataset_id = dataset_id)
m = m[1, ]
print(m)
```

## Download RNASeq data

Download data by complete pipeline

```{r es1}
es1 = search_rnaquantification(measurementset = m)
print(exprs(es1))
```

Download data for male subjects

```{r es2}
es2 = search_rnaquantification(measurementset = m, 
                               biosample = b2[b2$sex_ == 'male', ])
print(exprs(es2))
```

Download data for samples tagged by visit 1
```{r es3}
es3 = search_rnaquantification(measurementset = m, 
                               biosample = b2[b2$description == 'visit 1', ])
print(exprs(es3))
```

Download data for samples tagged by visit 1 and for features tagged with gene symbol IGLC4
```{r es4}
es4 = search_rnaquantification(measurementset = m, 
                               biosample = b2[b2$description == 'visit 1', ],
                               feature = search_features(gene_symbol = 'IGLC4'))
print(exprs(es4))
```
